const API_BASE = '/api/';

(function(){
  const API = '../api/';
  const qs = (s,ctx=document)=>ctx.querySelector(s);
  const qsa = (s,ctx=document)=>Array.prototype.slice.call(ctx.querySelectorAll(s));
  let INIT = {stations:[], personas:[], years:[]};
  let MODE = 'persona';
  const el = {
    modeBtns: qsa('#modeSwitch [data-mode]'),
    personaWrap: qs('#personaSelectWrap'), anioWrap: qs('#anioSelectWrap'),
    personaSel: qs('#personaSelect'), anioSel: qs('#anioSelect'),
    oaciAll: qs('#oaciAll'), oaciList: qs('#oaciList'),
    tabs: qs('#prestTabs'),
    pecosPersonaTbl: qs('#tblPecosPersona'), pecosYearTbl: qs('#tblPecosYear'),
    txtPersonaTbl: qs('#tblTxtPersona'), txtYearTbl: qs('#tblTxtYear'),
    vacPersonaTbl: qs('#tblVacPersona'), vacYearTbl: qs('#tblVacYear'),
    incPersonaTbl: qs('#tblIncPersona'), incYearTbl: qs('#tblIncYear'),
    txtPersona: qs('#txtPersona'), txtAnio: qs('#txtAnio'),
    vacPersona: qs('#vacPersona'), vacAnio: qs('#vacAnio'),
    incPersona: qs('#incPersona'), incAnio: qs('#incAnio'),
  };
  function lpad(n,w){n=String(n);return n.length>=w?n:'0'.repeat(w-n.length)+n;}
  function selectedStations(){const boxes=qsa('.oaci-switch'); if(!boxes.length || (el.oaciAll && el.oaciAll.checked)) return INIT.stations.slice(); const s=boxes.filter(b=>b.checked).map(b=>b.getAttribute('data-oaci')); return s.length?s:INIT.stations.slice();}
  function activeTab(){const a=qs('#prestTabs .nav-link.active'); return a?a.id.replace('tab-',''):'pecos';}
  function setMode(m){MODE=m; el.personaWrap.classList.toggle('d-none', m!=='persona'); el.anioWrap.classList.toggle('d-none', m!=='anio'); el.txtPersona.classList.toggle('d-none', m!=='persona'); el.txtAnio.classList.toggle('d-none', m!=='anio'); el.vacPersona.classList.toggle('d-none', m!=='persona'); el.vacAnio.classList.toggle('d-none', m!=='anio'); el.incPersona.classList.toggle('d-none', m!=='persona'); el.incAnio.classList.toggle('d-none', m!=='anio'); refreshActive();}
  async function init(){const r=await fetch(API+'prestaciones_init.php'); const data=await r.json(); INIT=data; if(el.oaciList){ el.oaciList.innerHTML=(INIT.stations||[]).map(o=>{const id='oaci_'+o; return '<div class="form-check form-switch"><input class="form-check-input oaci-switch" type="checkbox" role="switch" id="'+id+'" data-oaci="'+o+'" checked><label class="form-check-label" for="'+id+'">'+o+'</label></div>';}).join(''); qsa('.oaci-switch').forEach(i=>i.addEventListener('change',()=>{ if(!i.checked&&el.oaciAll) el.oaciAll.checked=false; refreshActive(); })); } if(el.oaciAll){ el.oaciAll.checked=true; el.oaciAll.addEventListener('change',()=>{const on=el.oaciAll.checked; qsa('.oaci-switch').forEach(i=>i.checked=on); refreshActive();}); } if(el.personaSel){ el.personaSel.innerHTML='<option value=\"\">Seleccione…</option>'+(INIT.personas||[]).map(r=>'<option value=\"'+r.control+'\">'+(r.oaci?(r.oaci+' · '):'')+lpad(r.control,4)+' · '+(r.nombres||'')+'</option>').join(''); } if(el.anioSel){ el.anioSel.innerHTML=(INIT.years||[]).map(y=>'<option value=\"'+y+'\">'+y+'</option>').join(''); } el.modeBtns.forEach(b=> b.addEventListener('click', ()=> setMode(b.getAttribute('data-mode')))); el.personaSel && el.personaSel.addEventListener('change', refreshActive); el.anioSel && el.anioSel.addEventListener('change', refreshActive); document.addEventListener('shown.bs.tab', (ev)=>{ if(ev.target && ev.target.id && ev.target.id.startsWith('tab-')) refreshActive();}); refreshActive();}
  function clearTable(t,msg){const tb=t&&t.tBodies&&t.tBodies[0]; if(tb) tb.innerHTML='<tr><td class="text-secondary">'+msg+'</td></tr>';}
  async function refreshActive(){const tab=activeTab(); const sts=selectedStations().join(','); if(MODE==='persona'){const c=parseInt(el.personaSel&&el.personaSel.value?el.personaSel.value:'0',10); if(!c){ if(tab==='pecos') clearTable(el.pecosPersonaTbl,'Seleccione un trabajador…'); if(tab==='txt') clearTable(el.txtPersonaTbl,'Seleccione un trabajador…'); if(tab==='vac') clearTable(el.vacPersonaTbl,'Seleccione un trabajador…'); if(tab==='inc') clearTable(el.incPersonaTbl,'Seleccione un trabajador…'); return;} await route(tab,{mode:'persona',control:c,stations:sts}); } else { const y=parseInt(el.anioSel&&el.anioSel.value?el.anioSel.value:String(new Date().getFullYear()),10); await route(tab,{mode:'anio',year:y,stations:sts}); } }
  async function route(tab, params){ if(tab==='pecos') await load('../api/pecos_list.php',params, rows=> params.mode==='persona'? renderPecosPersona(rows):renderPecosYear(rows)); if(tab==='txt') await load('../api/txt_list.php',params, rows=> params.mode==='persona'? renderTxtPersona(rows):renderTxtYear(rows)); if(tab==='vac') await load('../api/vacaciones_list.php',params, rows=> params.mode==='persona'? renderVacPersona(rows):renderVacYear(rows, params.year)); if(tab==='inc') await load('../api/incapacidades_list.php',params, rows=> params.mode==='persona'? renderIncPersona(rows):renderIncYear(rows));}
  async function load(url, params, cb){const u=new URL(url, window.location.href); Object.entries(params).forEach(([k,v])=>u.searchParams.set(k,String(v))); const r=await fetch(u.toString()); if(!r.ok) return; const d=await r.json(); if(!d.ok) return; cb(d.rows||[]);}
  function renderPecosPersona(rows){const tb=el.pecosPersonaTbl.tBodies[0]; tb.innerHTML=''; rows.forEach(r=>{const tr=document.createElement('tr'); tr.innerHTML='<td>'+r.year+'</td>'+Array.from({length:12},(_,i)=>'<td class="text-center">'+(r['dia'+(i+1)]||'0')+'</td>').join('')+'<td class="nowrap"><button class="btn btn-sm btn-outline-primary">Editar</button></td><td class="nowrap"><button class="btn btn-sm btn-outline-danger">Eliminar</button></td>'; tb.appendChild(tr);});}
  function renderPecosYear(rows){const tb=el.pecosYearTbl.tBodies[0]; tb.innerHTML=''; rows.forEach(r=>{const tr=document.createElement('tr'); tr.innerHTML='<td class="nowrap">'+(r.oaci||'')+'</td><td class="nowrap">'+lpad(r.control,4)+'</td><td>'+(r.nombres||'')+'</td>'+Array.from({length:12},(_,i)=>'<td class="text-center">'+(r['dia'+(i+1)]||'0')+'</td>').join('')+'<td class="nowrap"><button class="btn btn-sm btn-outline-primary">Editar</button></td><td class="nowrap"><button class="btn btn-sm btn-outline-danger">Eliminar</button></td>'; tb.appendChild(tr);});}
  function renderTxtPersona(rows){const tb=el.txtPersonaTbl.tBodies[0]; tb.innerHTML=''; rows.forEach(r=>{const tr=document.createElement('tr'); tr.innerHTML='<td>'+r.year+'</td>'+['js','vs','dm','ds','muert','ono'].map(k=>'<td class="text-center">'+(r[k]||'0')+'</td>').join('')+'<td class="nowrap"><button class="btn btn-sm btn-outline-primary">Editar</button></td><td class="nowrap"><button class="btn btn-sm btn-outline-danger">Eliminar</button></td>'; tb.appendChild(tr);});}
  function renderTxtYear(rows){const tb=el.txtYearTbl.tBodies[0]; tb.innerHTML=''; rows.forEach(r=>{const tr=document.createElement('tr'); tr.innerHTML='<td class="nowrap">'+(r.oaci||'')+'</td><td class="nowrap">'+lpad(r.control,4)+'</td><td>'+(r.nombres||'')+'</td>'+['js','vs','dm','ds','muert','ono'].map(k=>'<td class="text-center">'+(r[k]||'0')+'</td>').join('')+'<td>'+(r.fnac||'')+'</td><td class="nowrap"><button class="btn btn-sm btn-outline-primary">Editar</button></td><td class="nowrap"><button class="btn btn-sm btn-outline-danger">Eliminar</button></td>'; tb.appendChild(tr);});}
  function renderVacPersona(rows){const tb=el.vacPersonaTbl.tBodies[0]; tb.innerHTML=''; const now=new Date(); rows.forEach(r=>{const tr=document.createElement('tr'); const cls=vacRowClass(r,now); if(cls) tr.classList.add(cls); tr.innerHTML='<td>'+(r.year||'')+'</td><td>'+(r.tipo||'')+'</td><td>'+(r.periodo||'')+'</td><td>'+(r.inicia||'')+'</td><td>'+(r.reanuda||'')+'</td><td class="text-center">'+(r.dias||'0')+'</td><td class="text-center">'+(r.resta||'0')+'</td><td>'+(r.obs||'')+'</td><td class="nowrap"><button class="btn btn-sm btn-outline-primary">Editar</button></td><td class="nowrap"><button class="btn btn-sm btn-outline-danger">Eliminar</button></td>'; tb.appendChild(tr);});}
  function renderVacYear(rows, year){const tb=el.vacYearTbl.tBodies[0]; tb.innerHTML=''; const now=new Date(); rows.forEach(r=>{const tr=document.createElement('tr'); const cls=vacRowClass(r,now,year); if(cls) tr.classList.add(cls); tr.innerHTML='<td class="nowrap">'+(r.oaci||'')+'</td><td class="nowrap">'+lpad(r.control,4)+' · '+(r.nombres||'')+'</td><td class="text-center">'+(r.ant||'')+'</td><td class="text-center">'+(r.dias_asig||'')+'</td><td class="text-center">'+(r.pr_asig||'')+'</td><td class="text-center">'+(r.ant_asig||'')+'</td><td class="text-center">'+(r.dias_usados||'0')+'</td><td class="text-center">'+(r.pr_usados||'0')+'</td><td class="text-center">'+(r.ant_usados||'0')+'</td><td class="text-center">'+(r.dias_left||'0')+'</td><td class="text-center">'+(r.pr_left||'0')+'</td><td class="text-center">'+(r.ant_left||'0')+'</td><td class="nowrap"><button class="btn btn-sm btn-outline-primary">Editar</button></td><td class="nowrap"><button class="btn btn-sm btn-outline-danger">Eliminar</button></td>'; tb.appendChild(tr);});}
  function vacRowClass(r, now, selectedYear){const y=selectedYear|| (r.year?parseInt(r.year,10):null); if(!y) return ''; const left=parseInt(r.dias_left||r.resta||'0',10); if(isNaN(left)||left<=0) return ''; const end=new Date(y,5,30,23,59,59); const warnStart=new Date(y,0,1); if(now>=warnStart && now<=end){const diff=(end-now)/(1000*60*60*24); return diff<=90?'table-danger':'table-warning'; } return '';}
  function renderIncPersona(rows){const tb=el.incPersonaTbl.tBodies[0]; tb.innerHTML=''; rows.forEach(r=>{const tr=document.createElement('tr'); tr.innerHTML='<td>'+(r.INICIA||'')+'</td><td>'+(r.TERMINA||'')+'</td><td class="text-center">'+(r.DIAS||'0')+'</td><td>'+(r.UMF||'')+'</td><td>'+(r.DIAGNOSTICO||'')+'</td><td>'+(r.FOLIO||'')+'</td><td class="nowrap"><button class="btn btn-sm btn-outline-primary">Editar</button></td><td class="nowrap"><button class="btn btn-sm btn-outline-danger">Eliminar</button></td>'; tb.appendChild(tr);});}
  function renderIncYear(rows){const tb=el.incYearTbl.tBodies[0]; tb.innerHTML=''; rows.forEach(r=>{const tr=document.createElement('tr'); tr.innerHTML='<td class="nowrap">'+(r.oaci||'')+'</td><td class="nowrap">'+lpad(r.control,4)+' · '+(r.nombres||'')+'</td><td>'+(r.INICIA||'')+'</td><td>'+(r.TERMINA||'')+'</td><td class="text-center">'+(r.DIAS||'0')+'</td><td>'+(r.UMF||'')+'</td><td>'+(r.DIAGNOSTICO||'')+'</td><td>'+(r.FOLIO||'')+'</td><td class="nowrap"><button class="btn btn-sm btn-outline-primary">Editar</button></td><td class="nowrap"><button class="btn btn-sm btn-outline-danger">Eliminar</button></td>'; tb.appendChild(tr);});}
  document.addEventListener('DOMContentLoaded', init);
})();
